<!-- index.wxml -->
<view class="container">
  
  <!-- Header Area -->
  <view class="header-area">
    <view class="header-text">
      <text class="title">My Time Logger</text>
      <view class="subtitle-row">
        <text class="subtitle">è®°å½•ç”Ÿæ´»ï¼Œè§„åˆ’æœªæ¥</text>
        <view class="streak-badge" wx:if="{{streak > 0}}">ğŸ”¥ {{streak}} Days</view>
      </view>
    </view>
    
    <!-- Group Mode Switch (Unified) -->
    <view class="mode-switch">
      <!-- Time Tab Controls -->
      <block wx:if="{{currentTab === 'time'}}">
        <text class="{{timeViewMode === 'project' ? 'active' : ''}}" bindtap="switchGroupMode" data-mode="project">é¡¹ç›®</text>
        <text class="divider">|</text>
        <text class="{{timeViewMode === 'timeline' && timeGroupMode === 'week' ? 'active' : ''}}" bindtap="switchGroupMode" data-mode="week">å‘¨</text>
        <text class="divider">|</text>
        <text class="{{timeViewMode === 'timeline' && timeGroupMode === 'month' ? 'active' : ''}}" bindtap="switchGroupMode" data-mode="month">æœˆ</text>
      </block>

      <!-- Money Tab Controls -->
      <block wx:if="{{currentTab === 'money'}}">
        <text class="{{moneyGroupMode === 'week' ? 'active' : ''}}" bindtap="switchGroupMode" data-mode="week">å‘¨</text>
        <text class="divider">|</text>
        <text class="{{moneyGroupMode === 'month' ? 'active' : ''}}" bindtap="switchGroupMode" data-mode="month">æœˆ</text>
      </block>

      <!-- Output Tab Controls -->
      <block wx:if="{{currentTab === 'output'}}">
        <text class="{{outputGroupMode === 'week' ? 'active' : ''}}" bindtap="switchGroupMode" data-mode="week">å‘¨</text>
        <text class="divider">|</text>
        <text class="{{outputGroupMode === 'month' ? 'active' : ''}}" bindtap="switchGroupMode" data-mode="month">æœˆ</text>
      </block>
    </view>
  </view>

  <!-- Main Tabs -->
  <view class="tab-bar">
    <view class="tab-item {{currentTab === 'time' ? 'active' : ''}}" bindtap="switchTab" data-tab="time">â³ æ—¶é—´</view>
    <view class="tab-item {{currentTab === 'output' ? 'active' : ''}}" bindtap="switchTab" data-tab="output">ğŸ† äº§å‡º</view>
    <view class="tab-item {{currentTab === 'money' ? 'active' : ''}}" bindtap="switchTab" data-tab="money">ğŸ’° è´¦æœ¬</view>
  </view>

  <!-- === SCENE 1: TIME TAB === -->
  <view class="log-list" wx:if="{{currentTab === 'time'}}">
    
    <!-- Sub-Scene A: Timeline View (Hidden/Deprecated for now, accessible only via code) -->
    <block wx:if="{{timeViewMode === 'timeline'}}">
      <block wx:for="{{timeGroups}}" wx:for-item="group" wx:key="key" wx:for-index="groupIndex">
        <view class="group-header" bindtap="toggleGroup" data-index="{{groupIndex}}" data-type="time">
          <text class="group-title">{{group.title}}</text>
          <view class="group-meta"><text>{{group.totalDuration}} min</text><text class="arrow {{group.expanded ? 'down' : 'right'}}">â–¶</text></view>
        </view>
        <view class="group-items" hidden="{{!group.expanded}}">
          <block wx:for="{{group.items}}" wx:key="_id">
            <view class="card priority-border-{{item.task_info ? item.task_info.priority : 2}}" bindtap="goToEdit" data-id="{{item._id}}">
              <!-- Checkbox -->
              <view class="checkbox-area" catchtap="onToggleTaskStatus" data-id="{{item._id}}" data-status="{{item.task_info ? item.task_info.status : 'doing'}}">
                <view class="checkbox {{item.task_info && item.task_info.status === 'done' ? 'checked' : ''}}"></view>
              </view>
              
              <image wx:if="{{item.fileID}}" class="card-img" src="{{item.fileID}}" mode="aspectFill" lazy-load />
              <view class="card-content">
                <view class="card-top">
                  <text class="activity-name {{item.task_info && item.task_info.status === 'done' ? 'done-text' : ''}}">{{item.activity}}</text>
                  <view class="duration-badge">{{item.duration}} min</view>
                </view>
                <view class="card-footer-row">
                  <text class="note-text">{{item.note || 'No details...'}}</text>
                  <text class="date-text">{{item.dateStr}}</text>
                </view>
              </view>
            </view>
          </block>
        </view>
      </block>
      <block wx:if="{{timeGroups.length === 0 && !loading}}"><view class="empty-state"><text class="empty-emoji">â³</text><text class="empty-text">Empty...</text></view></block>
    </block>

    <!-- Sub-Scene B: Project View -->
    <block wx:if="{{timeViewMode === 'project'}}">
      <block wx:for="{{projectGroups}}" wx:for-item="project" wx:key="title" wx:for-index="idx">
        <view class="project-card {{project.status === 'done' ? 'project-done' : ''}}">
          <!-- New Unified Main Content Layout -->
          <view class="project-main-content">
            <!-- Left Section: Title & Update Time -->
            <view class="project-left-side" bindtap="toggleGroup" data-index="{{idx}}" data-type="project">
              <view class="checkbox-area" catchtap="onToggleProjectStatus" data-title="{{project.title}}" data-status="{{project.status}}" data-index="{{idx}}">
                <view class="checkbox {{project.status === 'done' ? 'checked' : ''}}"></view>
              </view>
              <view class="project-titles">
                <text class="project-title {{project.status === 'done' ? 'done-text' : ''}}">{{project.title}}</text>
                <text class="project-update">æœ€è¿‘æ›´æ–°: {{project.lastUpdateStr}}</text>
              </view>
            </view>

            <!-- Right Section: Duration & Quick Add Button -->
            <view class="project-right-side">
              <view class="project-stat-mini">
                <text class="stat-num-large">{{project.totalDuration}}</text>
                <text class="stat-unit-tiny">min</text>
              </view>
              <view class="add-btn-sm" wx:if="{{project.status !== 'done'}}" catchtap="onContinueProject" data-title="{{project.title}}">è¿½åŠ è®°å½•</view>
            </view>
          </view>
          
          <!-- History List (Collapsible) -->
          <view class="project-history" hidden="{{!project.expanded}}">
            <view class="history-divider"></view>
            <block wx:for="{{project.items}}" wx:key="_id">
              <view class="history-item" bindtap="goToEdit" data-id="{{item._id}}">
                <!-- Mini Checkbox -->
                <view class="checkbox-area" style="padding:0 15rpx 0 0;" catchtap="onToggleTaskStatus" data-id="{{item._id}}" data-status="{{item.task_info ? item.task_info.status : 'doing'}}">
                   <view class="checkbox {{item.task_info && item.task_info.status === 'done' ? 'checked' : ''}}" style="width:28rpx;height:28rpx;font-size:18rpx;border-width:2rpx;"></view>
                </view>
                
                <text class="h-date">{{item.dateStr}}</text>
                <text class="h-note {{item.task_info && item.task_info.status === 'done' ? 'done-text' : ''}}">{{item.note || '...'}}</text>
                <text class="h-duration">{{item.duration}}m</text>
              </view>
            </block>
          </view>
        </view>
      </block>
      <block wx:if="{{projectGroups.length === 0 && !loading}}"><view class="empty-state"><text class="empty-emoji">ğŸ“</text><text class="empty-text">No projects found.</text></view></block>
    </block>

  </view>

  <!-- === SCENE 2: OUTPUT TAB === -->
  <view class="log-list" wx:if="{{currentTab === 'output'}}">
    <block wx:for="{{outputGroups}}" wx:for-item="group" wx:key="key" wx:for-index="groupIndex">
      <view class="group-header" bindtap="toggleGroup" data-index="{{groupIndex}}" data-type="output">
        <text class="group-title">{{group.title}}</text>
        <view class="group-meta"><text class="arrow {{group.expanded ? 'down' : 'right'}}">â–¶</text></view>
      </view>
      <view class="group-items" hidden="{{!group.expanded}}">
        <block wx:for="{{group.items}}" wx:key="_id">
          <view class="card gold-card" bindtap="goToEdit" data-id="{{item._id}}">
            <view class="gold-icon">ğŸ†</view>
            <view class="card-content">
              <view class="card-top"><text class="activity-name">{{item.activity}}</text><view class="gold-badge">{{item.output_data.type || 'Output'}}</view></view>
              <view class="card-middle">
                <text class="note-text" wx:if="{{item.note}}">{{item.note}}</text>
                <view class="stars"><text wx:for="{{[1,2,3,4,5]}}" wx:key="*this" wx:for-item="i" class="{{i <= (item.output_data.satisfaction || 3) ? 'star-filled' : 'star-empty'}}">â˜…</text></view>
              </view>
              <view class="card-bottom"><text class="date-text">{{item.dateStr}}</text></view>
            </view>
          </view>
        </block>
      </view>
    </block>
    <block wx:if="{{outputGroups.length === 0 && !loading}}"><view class="empty-state"><text class="empty-emoji">ğŸ†</text><text class="empty-text">No outputs yet.</text></view></block>
  </view>

  <!-- === SCENE 3: MONEY TAB === -->
  <view class="log-list" wx:if="{{currentTab === 'money'}}">
    <view class="budget-card">
      <view class="budget-header"><text class="budget-label">æœ¬æœˆæ”¯å‡º</text><view class="budget-action" catchtap="onSetBudget">âš™ï¸ é¢„ç®—</view></view>
      <view class="budget-main"><text class="currency">Â¥</text><text class="amount-large">{{totalExpense}}</text></view>
      <view class="progress-container"><view class="progress-bar" style="width: {{budgetPercent}}%; background: {{budgetPercent > 90 ? '#ff6b6b' : '#4ecdc4'}}"></view></view>
      <view class="budget-footer"><text>é¢„ç®—: Â¥{{budget}}</text><text>å‰©ä½™: Â¥{{budget - totalExpense}}</text></view>
    </view>
    <block wx:for="{{moneyGroups}}" wx:for-item="group" wx:key="key" wx:for-index="groupIndex">
      <view class="group-header" bindtap="toggleGroup" data-index="{{groupIndex}}" data-type="money">
        <text class="group-title">{{group.title}}</text>
        <view class="group-meta"><text>æ”¯å‡º: {{group.totalAmount}}</text><text class="arrow {{group.expanded ? 'down' : 'right'}}">â–¶</text></view>
      </view>
      <view class="group-items" hidden="{{!group.expanded}}">
        <block wx:for="{{group.items}}" wx:key="_id">
          <view class="card money-card" bindtap="goToEdit" data-id="{{item._id}}">
            <image wx:if="{{item.fileID}}" class="card-img" src="{{item.fileID}}" mode="aspectFill" lazy-load />
            <view class="card-content">
              <view class="card-top"><text class="activity-name">{{item.activity}}</text><view class="money-badge">-{{item.amount}}</view></view>
              <view class="card-middle"><text class="note-text">{{item.note}}</text></view>
              <view class="card-bottom"><text class="date-text">{{item.dateStr}}</text></view>
            </view>
          </view>
        </block>
      </view>
    </block>
  </view>

  <view class="fab-btn" bindtap="goToCreate"><text>+</text></view>
</view>